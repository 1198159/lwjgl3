<project name="lwjgl native code" basedir="../.." default="compile-native-windows">
	<import file="../build-definitions.xml"/>

	<property name="libs" value="Kernel32.lib ole32.lib OpenGL32.Lib Version.lib user32.lib Gdi32.lib Advapi32.lib delayimp.lib winmm.lib Comctl32.lib"/>

	<condition property="dllname" value="lwjgl.dll" else="lwjgl64.dll">
		<equals arg1="${os.arch}" arg2="x86"/>
	</condition>

	<patternset id="link-objects">
		<include name="${bin.native}/*.obj"/>
		<include name="${lib}/windows/${os.arch}/*.lib"/>
	</patternset>

	<target name="-link" unless="link-uptodate">
		<apply dir="${bin.native}" executable="cl" failonerror="true" parallel="true" taskname="Linker">
			<arg line="/LD /WX /nologo"/>
			<srcfile/>
			<arg line="/Fe${dllname} /link"/>
			<arg value="/LIBPATH:${java.home}\..\lib"/>
			<arg value="/OPT:REF"/>
			<arg value="/OPT:ICF"/>
			<arg line="/DLL ${libs}"/>

			<fileset dir=".">
				<patternset refid="link-objects"/>
			</fileset>
		</apply>
	</target>

	<target name="compile-native-windows">
		<!-- COMPILE -->
		<apply dir="${bin.native}" executable="cl" dest="${bin.native}" skipemptyfilesets="true" failonerror="true" parallel="true" taskname="Compiler">
			<arg line="/c /Wall /WX /EHsc /Ox /Gy /MT /MP /nologo /DLWJGL_WINDOWS"/>

			<arg value="/I${java.home}\..\include"/>
			<arg value="/I${java.home}\..\include\win32"/>

			<!-- Paths relative to dir -->
			<arg value="/I${src.native.abs}\system"/>
			<arg value="/I${src.native.abs}\system\windows"/>
			<arg value="/I${src.native.abs}\system\glfw"/>
			<arg value="/I${src.native.abs}\openal"/>
			<arg value="/I${src.native.abs}\opencl"/>
			<arg value="/I${src.native.abs}\opengl"/>
			<arg value="/I${src.native.abs}\opengl\wgl"/>

			<!-- Paths relative to basedir -->
			<fileset dir="${src.native}/system" includes="*.c"/>
			<fileset dir="${src.native}/system/windows" includes="*.c"/>
			<fileset dir="${src.native}/system/glfw" includes="*.c"/>
			<fileset dir="${src.native}/opencl" includes="*.c"/>
			<fileset dir="${src.native}/opengl" includes="*.c"/>
			<fileset dir="${generated.native}/system" includes="*.c"/>
			<fileset dir="${generated.native}/system/glfw" includes="*.c"/>
			<fileset dir="${generated.native}/system/windows" includes="*.c"/>
			<fileset dir="${generated.native}/openal" includes="*.c"/>
			<fileset dir="${generated.native}/opencl" includes="*.c"/>
			<fileset dir="${generated.native}/opengl" includes="*.c"/>
			<fileset dir="${generated.native}/opengl/wgl" includes="*.c"/>

			<mapper type="glob" from="*.c" to="*.obj"/>
		</apply>

		<!-- LINK -->
		<uptodate property="link-uptodate" targetfile="${bin.native}/${dllname}">
			<srcfiles dir=".">
				<patternset refid="link-objects"/>
			</srcfiles>
		</uptodate>

		<antcall target="-link"/>
	</target>

	<!-- Bump this to force dependencies to be updated. -->
	<property name="revision" value="1"/>

	<target name="update-platform-dependencies">
		<mkdir dir="${lib}/windows"/>
		<mkdir dir="${lib}/windows/x86"/>
		<mkdir dir="${lib}/windows/amd64"/>

		<update-dropbox name="OpenAL32" artifact="windows/OpenAL32.dll" hash="i4zue33q7rs4d7k/eK66IxClph" dest="${lib}"/>
		<update-dropbox name="OpenAL64" artifact="windows/OpenAL64.dll" hash="i4zue33q7rs4d7k/th0369so9E" dest="${lib}"/>
		<update-dropbox name="GLFW32" artifact="windows/x86/glfw3.lib" hash="i4zue33q7rs4d7k/zb_3aaleWY" dest="${lib}"/>
		<update-dropbox name="GLFW64" artifact="windows/amd64/glfw3.lib" hash="i4zue33q7rs4d7k/YYcO-kCfU6" dest="${lib}"/>
	</target>
</project>